import{_ as p,r as i,o as r,c,b as e,d as s,a as t,e as n}from"./app-428ea39a.js";const o="/assets/image-4e7f52f5.png",l="/assets/image-1-522973e5.png",d="/assets/image-2-4b9e72df.png",m="/assets/image-3-166fb133.png",g="/assets/image-4-1024x143-c4a49fe8.png",v="/assets/image-5-1024x257-f915ac9f.png",u="/assets/image-6-1024x333-cfa46b47.png",_="/assets/image-7-7c51a7aa.png",h="/assets/image-8-1024x484-5385ede0.png",b="/assets/image-9-1024x435-56016078.png",f="/assets/image-10-1024x161-5ea94bac.png",P="/assets/image-11-1024x983-ce628bba.png",I="/assets/image-13-1024x530-e0554595.png",x="/assets/image-12-43c08978.png",k="/assets/image-14-1024x783-094c6b6a.png",w="/assets/image-15-1024x173-0fd6ddf3.png",A="/assets/image-16-1024x538-4b38ada2.png",N="/assets/image-18-20673da7.png",T={},S=e("h1",{id:"校内-ipv6-设置教程",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#校内-ipv6-设置教程","aria-hidden":"true"},"#"),s(" 校内 IPv6 设置教程")],-1),D=e("p",null,"本篇教程是在南方科技大学的网络环境下写成。据我所知，下发128位前缀 IPv6 地址的学校不止南科大一所，本篇教程事实上具有普适性，其他大学的同学也可以进行参考。",-1),E=e("p",null,"事实上，在中国电信的家宽一般下发56位前缀的地址，也可使用本方法，但并无必要，可直接由路由分配地址无需 NAT。",-1),C=e("p",null,"南科大的 IPv6 下发的地址是 128位前缀，换言之，子网大小为 1，仅够一台设备使用。为了让一个物理网口下的多个设备共享网络，常见的解决方案是（1）交换机（2）路由器。两者的区别想必需要用到此教程的同学应该了解，这里仅介绍具体配置。",-1),O=e("h2",{id:"ipv6-桥接",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#ipv6-桥接","aria-hidden":"true"},"#"),s(" IPv6 桥接")],-1),W={href:"https://www.miit.gov.cn/jgsj/txs/wjfb/art/2020/art_ed97eb9802da4f168acb823227663f1b.html",target:"_blank",rel:"noopener noreferrer"},R=n('<p>在南科大校园网下，在 IPv6 的设置中选择 “桥接模式” 或 ”中继模式“，下级设备应该能分配到 2001 开头的公网 IPv6 地址。</p><h2 id="ipv6-nat-©️-戴郭轶" tabindex="-1"><a class="header-anchor" href="#ipv6-nat-©️-戴郭轶" aria-hidden="true">#</a> IPv6 NAT ©️ 戴郭轶</h2><p>一些同学如果有特殊需求可能会使用 OpenWrt，里面有丰富的插件提供多样的服务。</p><p>这篇教程可以说是一篇咕咕咕了很久的教程，大概是在去年才开学的时候，当时公网限速在 700KB/s，所以就买了新路由3刷了 OpenWrt 进行多拨来解除限速，（现在解除了，最快能够跑到 90MB/s 左右，没有必要使用多拨来提升带宽）。不过当时也花了很久配置 IPv6 的经验，可能仍值得分享。</p><p>由于南科大的分配的128位前缀的地址，子网空间不足，需要使用本该被淘汰掉的 NAT 网络地址转换使得下级设备能够联网，正确配置后的效果如下：</p><p><img src="'+o+'" alt="img"></p><p>同时北洋园和蒲公英pt均能正常识别（需要在OpenWrt开启 UPnP ）：</p><p><img src="'+l+'" alt="img"></p><p><img src="'+d+'" alt="img"></p><p><strong>（PS：不要学我IPv6不打码直接发，因为 v6 默认就是公网地址，我在发完教程后会使用新的地址）</strong></p><p>电脑能成功获取内网IPv6,同时手机也能获得64位的 v6 地址，正常访问 v6 网络：</p><p><img src="'+m+'" alt="img"></p><p>相应的流程并不复杂，只需要一台刷入OpenWrt的路由器，一台电脑，WinSCP（可选），以及足够的耐心。</p><p>首先，我们需要登录进入路由器的后台管理页面,依次点击网络-接口：</p><p>将全局网络选项前缀进行修改，我个人使用的是 <code>fd34:fe56:7891:2f3a::/64</code>；可以按照自己喜好选择一个内网前缀。</p><p><img src="'+g+'" alt="img"></p><p>随后单击lan一栏的修改，我们需要修改一下内网的设置，滑到下方，点击高级设置，按照下图进行勾选：</p><p><img src="'+v+'" alt="img"></p><p>然后点击IPv6设置，路由器通告服务和DHCPv6服务修改为服务器模式，NDP代理设置为禁用，DHCPv6选择无状态的+有状态的，并勾选总是通告默认路由：</p><p><img src="'+u+'" alt="img"></p><p>完成后点击保存&amp;应用。</p><p>随后进入wan口的设置，勾选上使用内置的IPv6管理</p><p><img src="'+_+'" alt="img"></p><p>随后进入wan6口的设置，将协议修改为DHCPv6客户端，请求IPv6地址为force，请求指定长度的IPv6前缀为已禁用：</p><p><img src="'+h+'" alt="img"></p><p>进入高级设置，勾选上使用内置的IPv6管理，强制链路和使用默认网关：</p><p><img src="'+b+'" alt="img"></p><p>之后选择网络-DHCP/DNS，进入高级设置，取消勾选禁止解析IPv6 DNS记录：</p><p><img src="'+f+'" alt="img"></p><p>进入网络-防火墙：</p><p>将转发改为接受，下面的区域也需要改：</p><p><img src="'+P+'" alt="img"></p><p>进入自定义规则，粘贴如下内容：</p><p><img src="'+I+`" alt="img"></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>WAN6=eth0.2
LAN=br-lan
ip6tables -t nat -A POSTROUTING -o $WAN6 -j MASQUERADE
ip6tables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 <code>eth0.2</code> 和 <code>br-lan</code> 需要修改为你网络-接口中显示的内容：</p><p><img src="`+x+'" alt="img"></p><p>2023.3.22 更新：</p><p>在新版本的linux/openwrt 中，iptables 已经被 nftables 取代，上述命令可能执行失败，我们可以使用以下命令来解决： ip6tables -t nat -I POSTROUTING -s `uci get network.globals.ula_prefix` -j MASQUERADE 这样就无需上述防火墙自定义规则的配置了。</p><p>如果有多拨需求的，提醒一下需要在负载均衡中将 defalut-rule 的备用成员改成默认（使用主路由表），由于我重新刷机做的教程且现在没有多拨的必要，就不演示了，没有需求的可以略过这一点。</p><p>经过如上配置，重启路由器后，在网络，诊断中应该能够成功 ping 通 openwrt.org 的v6了，说明你的路由器已经成功接入 IPv6 网络了：</p><p><img src="'+k+'" alt="img"></p>',42),U={href:"https://www.test-IPv6.com/",target:"_blank",rel:"noopener noreferrer"},j=n(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>route <span class="token parameter variable">-A</span> inet6 <span class="token function">add</span> default gw fe80::3e8c:93ff:fed0:83c2 dev eth0.2
/etc/init.d/firewall restart
/etc/init.d/network restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，第一行的fe80开头的一串v6地址需要修改为本机的默认网关，可以在状态-概览下获得，如图：</p><p><img src="`+w+'" alt="img"></p>',3),B={href:"https://www.test-IPv6.com/",target:"_blank",rel:"noopener noreferrer"},y=n('<p><img src="'+A+`" alt="img"></p><p>但是，如果路由器关机重启后，我们刚才输入的三行代码会丢失，也就是会回到路由器有 IPv6 而电脑无法连接 IPv6 的状态，这个时候我们就需要编辑一个开机自启的脚本，让路由器再开机时自动添加：</p><p>具体操作为：使用 WinSCP 连接并登陆进入路由器，在 <code>/etc/hotplug.d/iface/</code> 目录下新建名为 <code>restart-IPv6</code> 的文件，修改内容为：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/sh</span>
<span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$ACTION</span>&quot;</span> <span class="token operator">=</span> <span class="token function">ifup</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>
route <span class="token parameter variable">-A</span> inet6 <span class="token function">add</span> default gw fe80::3e8c:93ff:fed0:83c2 dev eth0.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2023.3.22 更新： 如果无法在防火墙自定义规则处修改，请在脚本中添加相关命令。</p><p>最后一行需要修改成和刚才一样的内容，然后给予可执行权限。</p><p>没有 WinSCP 的可以在终端内输入以下内容：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/hotplug.d/iface/restart-IPv6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后再文本框中输入上面的三行内容，按 Esc 后退出 insert 模式，输入 <code>:wq</code> 退出。</p><p>然后给予可执行权限：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">chmod</span> +x /etc/hotplug.d/iface/restart-IPv6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+N+'" alt="img"></p><p>这个时候，恭喜你，成功配置IPv6了哦~</p><p>对了，如果有挂pt需求的同学，别忘了在服务-UPnP中打开哦~</p><p>还存在一些应该是OpenWrt本身的问题，在使用IPv6的时候，无法手动配置端口转发，UPnP的端口转发是成功的，但是在防火墙下无法配置，使用 Socat 也没有成功。</p><p>感谢阅读！如果有什么问题或者建议，可以和我发邮件联系。</p><p>我的个人邮箱为：ntdgy2001@gmail.com / 12011211@mail.sustech.edu.cn</p>',17),H={href:"https://ntdgy.top/ntdgy/30.html",target:"_blank",rel:"noopener noreferrer"};function L(V,q){const a=i("ExternalLinkIcon");return r(),c("div",null,[S,D,E,C,O,e("p",null,[s("根据工信部"),e("a",W,[s("《关于开展2019年IPv6网络就绪专项行动的通知》"),t(a)]),s(" 的要求，“新部署的家庭网关设备应全部支持IPv6，并默认配置支持IPv4/IPv6双栈，能够为网关下挂设备分配 IPv6 地址”。同学们新购买的路由器应该都支持 IPv6。例如水星等，国产路由器一般会将 IPv6 与 IPv4的设置分开。")]),R,e("p",null,[s("但是如果我们打开 "),e("a",U,[s("https://www.test-IPv6.com/"),t(a)]),s(" ，我们电脑还是没有连上v6的，这里就需要我们修改流量转发的路由表了，使用ssh工具连上路由器，没有的可以点击系统-TTYD终端：依次输入一下代码：")]),j,e("p",null,[s("而后面的eth0.2就是你网口的编号了，和防火墙哪那里一样，这个时候我们再打开 "),e("a",B,[s("https://www.test-IPv6.com/"),t(a)]),s(" ，可以发现，我们电脑已经接入IPv6了：")]),y,e("p",null,[s("原文章地址（NAT 部分）©️ 戴郭轶：["),e("a",H,[s("https://ntdgy.top/ntdgy/30/"),t(a)]),s("]")])])}const G=p(T,[["render",L],["__file","index.html.vue"]]);export{G as default};
